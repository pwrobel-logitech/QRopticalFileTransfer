#Make the custom toolchain first from the android NDK
#$NDK/build/tools/make_standalone_toolchain.py \
#    --arch arm --api 14 --install-dir /tmp/my-android-toolchain

current_dir = $(shell pwd)
LIBQRENCODER_LIBFOLDERNAME=libqrencode
LIBZXING=zxing_lib/zxing-cpp/core/src

x86_lib: open_rs_encoder.cpp qr_frame_producer.cpp fileutil/fileops.cpp libqrencode_wrapper
	g++ -I$(current_dir) -I$(current_dir)/libqrencoder_wrapper -fPIC -O0 -g -shared open_rs_encoder.cpp qr_frame_producer.cpp hash-library/sha256.cpp $(current_dir)/fileutil/fileops.cpp -o libRSencoder.so -L$(current_dir)/bin_fec_x64 -lfec -lqrencoder_wrapper

fec_x86_test: ka9q_fac_test.cpp single_fac_test.cpp fileutil/fileops.cpp
	g++ -g -O0 ka9q_fac_test.cpp -Wl,-rpath=\$$ORIGIN -o bin_fec_x64/fec_x86_test -L$(current_dir)/bin_fec_x64 -lfec
	g++ -g -O0 single_fac_test.cpp -Wl,-rpath=\$$ORIGIN -o bin_fec_x64/test_single -L$(current_dir)/bin_fec_x64 -lfec

clean:
	rm bin_fec_x64/fec_x86_test bin_fec_x64/test_single *.o *.so main bin_fec_x64/libqrencoder_wrapper.so bin_fec_x64/libqrencoder_test bin_fec_x64/decoder_test bin_fec_x64/libRSdecoder.so

main: main.cpp
	g++ -I$(current_dir) -g -O0 main.cpp -o main -L$(current_dir) -lRSencoder -L$(current_dir)/bin_fec_x64 -lfec -lqrencoder_wrapper

libqrencode_wrapper:
	g++ -g -O0 -DSTATIC_IN_RELEASE=static -DMAJOR_VERSION=1 -DMINOR_VERSION=1 -DVERSION=\"1\" -DMICRO_VERSION=1 -I$(current_dir) -I$(current_dir)/.. -I$(current_dir)/../$(LIBQRENCODER_LIBFOLDERNAME) -I$(current_dir)/libqrencoder_wrapper libqrencoder_wrapper/libqrencoder_wrapper.cpp $(current_dir)/bin_jpeg/arch_x86_64/libjpeg.a -I$(current_dir)/$(LIBZXING) -I$(current_dir)/zxing_lib $(current_dir)/zxing_lib/BufferBitmapSource.cpp $(current_dir)/zxing_lib/arch_x86_64/libzxing.a $(current_dir)/../$(LIBQRENCODER_LIBFOLDERNAME)/*.c -fPIC -shared -o $(current_dir)/bin_fec_x64/libqrencoder_wrapper.so  
	g++ -g -O0 -I$(current_dir) -I$(current_dir)/libqrencoder_wrapper libqrencoder_wrapper/libqrencoder_wrapper_test.cpp -fPIC -pie -o $(current_dir)/bin_fec_x64/libqrencoder_test -L$(current_dir)/bin_fec_x64 -lqrencoder_wrapper

x86_decoder_lib: libqrencode_wrapper decoder/qr_frame_decoder.cpp decoder/rs_decoder.cpp
	g++ -g -O0 -I$(current_dir) -I$(current_dir)/fec_include -I$(current_dir)/decoder decoder/qr_frame_decoder.cpp $(current_dir)/decoder/rs_decoder.cpp $(current_dir)/fileutil/fileops.cpp $(current_dir)/hash-library/sha256.cpp -shared -fPIC -o $(current_dir)/bin_fec_x64/libRSdecoder.so -L$(current_dir)/bin_fec_x64 -lfec -lqrencoder_wrapper

x86_decoder_test: x86_decoder_lib decoder/decoder_test.cpp 
	g++ -g -O0 -I$(current_dir) -I$(current_dir)/decoder decoder/decoder_test.cpp -fPIC -o $(current_dir)/bin_fec_x64/decoder_test -L$(current_dir)/bin_fec_x64 -lRSdecoder -lqrencoder_wrapper

main_linuxqr: x86_lib libqrencode_wrapper
	g++ -g -O0 -I$(current_dir) -I$(current_dir)/libqrencoder_wrapper -I$(current_dir)/linux_qrgen -Wl,-rpath=\$$ORIGIN linux_qrgen/main_qrgen.cpp -o bin_fec_x64/sendqr

all: x86_lib fec_x86_test x86_decoder_test main main_linuxqr


